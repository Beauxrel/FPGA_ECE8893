name: Vitis Tcl Build (Linux 22.04)

on:
  push:
    paths:
      - '2026_Spring/lab0/**'
      - '2026_Spring/lab1/**'
      - '2026_Spring/lab2/**'
      - '2026_Spring/lab3/**'
      - '2026_Spring/lab4/**'
      - '.github/workflows/**'
  pull_request:
    paths:
      - '2026_Spring/lab0/**'
      - '2026_Spring/lab1/**'
      - '2026_Spring/lab2/**'
      - '2026_Spring/lab3/**'
      - '2026_Spring/lab4/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, linux]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Add directory to PATH
        run: |
          echo "/tools/Xilinx/2025.1/Vitis/bin" >> $GITHUB_PATH
          source /tools/Xilinx/2025.1/Vitis/settings64.sh
          source /tools/Xilinx/2025.1/Vivado/settings64.sh
          source /tools/Xilinx/2025.1/Vivado/.settings64-Vivado.sh
          source /tools/Xilinx/2025.1/Vitis/.settings64-Vitis.sh

          echo $GITHUB_PATH
          echo $PATH

      - name: Build and test (gate on TEST PASSED)
        shell: bash
        run: |
          set -euo pipefail

          echo $PATH
          mkdir -p logs out
          cd 2026_Spring/lab1

          echo "Running make..."
          make

          if [[ ! -f result ]]; then
            echo "❌ ERROR: result was not generated by make"
            ls -la
            exit 1
          fi

          chmod +x result

          echo "Running tests..."
          ./result | tee ../../logs/result.log

          if ! grep -q "TEST PASSED" ../../logs/result.log; then
            echo "❌ TEST PASSED not found — failing workflow"
            exit 1
          fi

          echo "✅ TEST PASSED detected — continuing"

          vitis-run --tcl script.tcl


      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: vitis-logs
          path: logs/

      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: vitis-out
          path: out/
          
      - name: C Synthesis Report
        uses: actions/upload-artifact@v4
        with:
          name: top_kernel_csynth-report
          path: 2026_Spring/lab1/project_1/hls/syn/report/top_kernel_csynth.rpt
          
      - name: C/RTL Co-Simulation Report
        uses: actions/upload-artifact@v4
        with:
          name: top_kernel_cosim-report
          path: 2026_Spring/lab1/project_1/hls/sim/report/top_kernel_cosim.rpt
          
      - name: Post-Implementation Report (Place & Route)
        uses: actions/upload-artifact@v4
        with:
          name: top_kernel_export-report
          path: 2026_Spring/lab1/project_1/hls/impl/report/verilog/top_kernel_export.rpt
